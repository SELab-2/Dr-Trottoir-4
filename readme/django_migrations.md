# Migrations in Django

Django migrations are used to propagate changes made in our models ([models.py](../backend/drtrottoir/models.py)) to our database schema.
This guide explains everything you need to know about migrations in Django, but a more detailed guide can be found [here](https://docs.djangoproject.com/en/4.1/topics/migrations/).

**Warning**:
The filenames and content of these files can never be changed, as this will cause problems for those who already executed these migrations!


### Execute migrations

To just execute the migrations that are added to the project, you can use the bash script [migrations.sh](../migrations.sh): 

```
$ ./migrations.sh
```

This will execute all migrations that were not yet applied to the database. 

### Model migrations

To create a new migration based on the changes you have made to the model in [models.py](../backend/drtrottoir/models.py), use the command:
```python manage.py makemigrations```

but in our case we need to execute this in our docker container (in the project directory), so we use instead:

```
docker-compose exec backend python manage.py makemigrations
```

Make sure that your docker container is running with `docker-compose up`.

New migrations that are created have a unique identifier, this identifier is just an autoincremented id. 

There are already some migration files in our project, these can be found in the [migrations](../backend/drtrottoir/migrations) folder. 

**Warning**:
**The filenames and content of these files can never be changed, as this will cause problems for those who already executed these migrations!**
> This is because django keeps track of a migration history inside the database, in this table the filename is tracked.

**Instead just create a new migrations on top of the already executed migrations.**

The migrations that are created with the commands above, need to be migrated to the database. This is where this command comes in: ```
python manage.py migrate```

Or in our case again inside a docker container:

```
docker-compose exec backend python manage.py migrate
```

### Data migrations
Finally, we can also use migrations to insert (or remove) data in our database. These are called data migrations, more info can be found [here](https://docs.djangoproject.com/en/4.1/topics/migrations/#data-migrations).

To create a new autogenerated data migration we can use the command:
```python manage.py makemigrations --empty yourappname```

but because we use docker and our app is called *drtrottoir*, we use the command:
```
docker-compose exec backend python manage.py makemigrations --empty drtrottoir
```

In this migration we can then define a function that inserts/removes data. 
This needs to be added to the operations list inside the migration class and then the migration can be executed by using the same command as with model migrations:
```
docker-compose exec backend python manage.py migrate
```

An example of a data migration file is [0002_auto_20230227_1453.py](../backend/drtrottoir/migrations/0002_auto_20230227_1453.py).

### View data migrations in postgres

To check if the data migrations are migrated to the database, we can log onto the postgres docker container:
We can do this by first checking our running containers, using the command:
```
$ docker ps
CONTAINER ID   IMAGE                COMMAND                  CREATED              STATUS              PORTS                                                              NAMES
7742c9f9dfcb   project-frontend     "docker-entrypoint.s…"   About a minute ago   Up About a minute                                                                      project-frontend-1
075ff1639b24   project-backend      "python manage.py ru…"   About a minute ago   Up About a minute                                                                      project-backend-1
32771801b817   reverseproxy         "/docker-entrypoint.…"   About a minute ago   Up About a minute   0.0.0.0:80->80/tcp, 0.0.0.0:443->443/tcp, 0.0.0.0:2002->2002/tcp   project-reverseproxy-1
68e6b6e00ab1   postgres:15-alpine   "docker-entrypoint.s…"   26 hours ago         Up About a minute   0.0.0.0:5432->5432/tcp
```
In the output we can view the `CONTAINER ID` the postgres container has, in this case it is `68e6b6e00ab1`.

Finally, we can log onto the container with the command:
```
$ docker exec -it <container_id> psql -U django drtrottoir
```
here you replace `<container_id>` with the corresponding container id.

Now if we want to do any operation in sql, we can do so. The tables that are created in the database get named by django. Django names the tables like `appname_modelname`.

For example if we want the rows of our users, we can type:

```
drtrottoir=# SELECT * from drtrottoir_user;
```

To get a list of all tables created by django, you can use the command:
```
drtrottoir=# \dt
```

### Conclusion

That's it, this is everything you need to know about django migrations.

