# Migrations in Django

Django migrations are used to propagate changes made in our models ([models.py](../backend/base/models.py)) to our database schema.
This guide explains everything you need to know about migrations in Django, but a more detailed guide can be found [here](https://docs.djangoproject.com/en/4.1/topics/migrations/).

**Warning**:
The filenames and content of these files can never be changed, as this will cause problems for those who already executed these migrations!


### Execute migrations

To just execute the migrations that are added to the project, you can use the bash script [migrations.sh](../migrations.sh): 

```
$ ./migrations.sh
```

This will execute all migrations that were not yet applied to the database. 

### Model migrations

To create a new migration based on the changes you have made to the model in [models.py](../backend/base/models.py), use the command:
```python manage.py makemigrations```

but in our case we need to execute this in our docker container (in the project directory), so we use instead:

```
docker-compose exec backend python manage.py makemigrations
```

Make sure that your docker container is running with `docker-compose up`.

New migrations that are created have a unique identifier, this identifier is just an autoincremented id. 

There are already some migration files in our project, these can be found in the [migrations](../backend/base/migrations) folder. 

**Warning**:
**The filenames and content of these files can never be changed, as this will cause problems for those who already executed these migrations!**
> This is because django keeps track of a migration history inside the database, in this table the filename is tracked.

**Instead just create a new migrations on top of the already executed migrations.**

The migrations that are created with the commands above, need to be migrated to the database. This is where this command comes in: ```
python manage.py migrate```

Or in our case again inside a docker container:

```
docker-compose exec backend python manage.py migrate
```

### Data migrations
Finally, we can also use migrations to insert (or remove) data in our database. These are called data migrations, more info can be found [here](https://docs.djangoproject.com/en/4.1/topics/migrations/#data-migrations).

To create a new autogenerated data migration we can use the command:
```python manage.py makemigrations --empty yourappname```

but because we use docker and our app is called *drtrottoir*, we use the command:
```
docker-compose exec backend python manage.py makemigrations --empty drtrottoir
```

In this migration we can then define a function that inserts/removes data. 
This needs to be added to the operations list inside the migration class and then the migration can be executed by using the same command as with model migrations:
```
docker-compose exec backend python manage.py migrate
```

An example of a data migration file is [0002_auto_20230227_1453.py](../backend/base/migrations/0002_auto_20230227_1453.py).

### Conclusion

That's it, this is everything you need to know about django migrations.

